<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplicacion Medica</title>
    {% load static %}
    <link href="{% static 'css/styles.css'%}" rel="stylesheet" />
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>

    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet" type="text/css" />
    <!-- Custom CSS-->
    <script src="{% static 'js/scripts.js' %}"></script>
</head>
<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark" id="mainNav">
        <div class="container">
          <a id="Logo_UFV" class="navbar-brand" href="#page-top">
            <img src="{% static 'assets/img/logo_UFV_positivo.svg' %}" alt="Logo UFV" />
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            Menu
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
              <li class="nav-item"><a class="nav-link" href="#preescripcion">informe</a></li>
              <li class="nav-item"><a class="nav-link" href="#Clusters">Clusters</a></li>
              <li class="nav-item"><a class="nav-link" href="#Especialidades">Especialidades y Clúster</a></li>
              <li class="nav-item"><a class="nav-link" href="#Visualizacion">Analisis contenido Cluster</a></li>
              <li class="nav-item"><a class="nav-link" href="#VisualizacionEspecialidades">Visualizacion Especialidades</a></li>
              <li class="nav-item"><a class="nav-link" href="#contacto">Contacto</a></li>
            </ul>
          </div>
        </div>
      </nav>
      
         
    <!-- Masthead-->
    <header class="masthead">
        <div class="container" id="containerBienvenida">
            <div class="masthead-subheading">Bienvenido Doctor:</div>
            <div class="masthead-heading text-uppercase">Un placer verle de nuevo</div>
            <a class="btn btn-primary btn-xl text-uppercase" href="#preescripcion">Continuar:</a>
        </div>
    </header>
    <!-- REDACTAR PRESCRIPCIÓN -->
    <section class="page-section" id="preescripcion">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">introducir informe médico transcrito</h2>
                <h3 class="section-subheading text-muted">Introduce tu transcripción médica para obtener la predicción del clúster, especialidad y características principales.</h3>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="form-group">
                        <textarea id="transcription" class="form-control" placeholder="Enter your transcription" rows="4"></textarea>
                    </div>
                    <div class="form-group text-center">
                        <button onclick="fetchPrediction()" class="btn btn-primary btn-xl text-uppercase">Identify Cluster</button>
                    </div>
                    <div id="result" class="alert" role="alert" style="display: none;"></div>
                </div>
            </div>
        </div>
    </section>
    
    <script>
        function fetchPrediction() {
            const transcription = document.getElementById('transcription').value;
            const resultDiv = document.getElementById('result');

            // Limpiar resultados anteriores
            resultDiv.style.display = 'none';
            resultDiv.classList.remove('alert-info', 'alert-danger');
            resultDiv.innerText = '';

            // Enviar la solicitud
            fetch(`/aplicacion1/predict_cluster/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ transcription: transcription })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultDiv.classList.add('alert-danger');
                    resultDiv.innerText = data.error;
                } else {
                    resultDiv.classList.add('alert-info');
                    resultDiv.innerText = `Cluster: ${data.cluster}, Common Specialty: ${data.common_specialty}, Top Features: ${data.top_features.join(', ')}`;
                }
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.classList.add('alert-danger');
                resultDiv.innerText = 'An error occurred while fetching the prediction.';
                resultDiv.style.display = 'block';
            });
        }
    </script>
    
    <!-- ANALISIS DE CLUSTERS -->
    {% load static %}
    {% load custom_filters %}
    
   
    <section class="page-section bg-light" id="Clusters">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Análisis de Clústeres</h2>
            </div>
            <div class="row">
                {% for cluster, data in clusters_features.items %}
                <div class="col-lg-4 col-sm-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Cluster {{ cluster_titles|get_item:cluster }}</h5>
                            <p class="card-text">1-Especialidad Principal: {{ data.specialties.0 }}</p>
                            <p class="card-text">2-Especialidad Secundaria: {{ data.specialties.1 }}</p>
                            <p class="card-text">3-Especialidad Terciaria: {{ data.specialties.2 }}</p>
                            <p class="card-text">Características Principales: {{ data.features|join:", " }}</p>
                            <h6>Análisis del Clúster:</h6>
                            <p class="card-text">{{ cluster_analysis|get_item:cluster }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    
    
    <!-- Cluster mas comun para cada especialidad -->
  <!-- Especialidades Médicas y sus Clústeres Más Comunes -->
<section class="page-section bg-light" id="Especialidades">
    <div class="container">
        <div class="text-center">
            <h2 class="section-heading text-uppercase">Especialidades Médicas y sus Clústeres Más Comunes</h2>
        </div>
        <div class="row">
            {% for specialty, clusters in common_clusters_by_specialty.items %}
            <div class="col-lg-4 col-sm-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ specialty }}</h5>
                        <p class="card-text">Cluster Más Común: {{ clusters.0 }}</p>
                        <p class="card-text">
                            Segundo Cluster Más Común: 
                            {% if clusters|length > 1 %}
                                {{ clusters.1 }}
                            {% else %}
                                No disponible
                            {% endif %}
                        </p>
                        <p class="card-text">
                            Tercer Cluster Más Común: 
                            {% if clusters|length > 2 %}
                                {{ clusters.2 }}
                            {% else %}
                                No disponible
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
    <!--PCA VISUALIZACION EN 3D-->
    <!-- <section class="page-section bg-light" id="Visualizacion">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Visualización Clusters</h2>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <iframe src="{% static 'assets/clusters_3d.html' %}" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        </div>
    </section>    -->
    <section class="page-section bg-light" id="Visualizacion">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Filtrar Informes</h2>
                <p class="text-muted">Selecciona uno o varios clústeres y una especialidad para ver los informes asociados.</p>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <label for="cluster-select">Clúster:</label>
                    <!-- Permite múltiples selecciones y mayor tamaño -->
                    <select id="cluster-select" class="form-control" multiple size="12">
                        {% for cluster_id, cluster_name in cluster_titles.items %}
                            <option value="{{ cluster_id }}">{{ cluster_name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios clústeres.</small>
                </div>
                <div class="col-lg-6">
                    <label for="specialty-select">Especialidad:</label>
                    <select id="specialty-select" class="form-control">
                        <option value="">--Selecciona una especialidad--</option>
                        {% for specialty in specialties %}
                            <option value="{{ specialty }}">{{ specialty }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
    
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div id="filtered-reports-cluster">
                        <!-- Aquí se mostrarán los informes filtrados, agrupados por clúster -->
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal para visualizar cada informe individualmente -->
    <section class="page-section bg-light" id="Visualizacion">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Filtrar Informes</h2>
                <p class="text-muted">Selecciona uno o varios clústeres y una especialidad para ver los informes asociados.</p>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <label for="cluster-select">Clúster:</label>
                    <!-- Permite múltiples selecciones y mayor tamaño -->
                    <select id="cluster-select" class="form-control" multiple size="12">
                        {% for cluster_id, cluster_name in cluster_titles.items %}
                            <option value="{{ cluster_id }}">{{ cluster_name }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Mantén presionada la tecla Ctrl (o Cmd en Mac) para seleccionar varios clústeres.</small>
                </div>
                <div class="col-lg-6">
                    <label for="specialty-select">Especialidad:</label>
                    <select id="specialty-select" class="form-control">
                        <option value="">--Selecciona una especialidad--</option>
                        {% for specialty in specialties %}
                            <option value="{{ specialty }}">{{ specialty }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
    
            <div class="row mt-4">
                <div class="col-lg-12">
                    <div id="filtered-reports-cluster">
                        <!-- Aquí se mostrarán los informes filtrados, agrupados por clúster -->
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Modal para visualizar cada informe individualmente -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reportModalLabel">Informe</h5>
            <button type="button" class="btn-close" data-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p id="reportContent">Aquí se mostrará el contenido del informe.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="prevReportBtn">Anterior</button>
            <button type="button" class="btn btn-primary" id="nextReportBtn">Siguiente</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    
    <script>
        // Array global con todos los informes (de uno o varios clústeres)
        let currentReports = [];
        let currentIndex = 0;
    
        // Referencias al DOM
        const container = document.getElementById('filtered-reports-cluster');
        const reportContent = document.getElementById('reportContent');
        const prevReportBtn = document.getElementById('prevReportBtn');
        const nextReportBtn = document.getElementById('nextReportBtn');
    
        // Función principal para obtener los informes agrupados
        function fetchReports() {
            const specialty = document.getElementById('specialty-select').value;
            const clusterSelect = document.getElementById('cluster-select');
    
            // Obtener TODOS los clústeres seleccionados
            const selectedClusters = Array.from(clusterSelect.options)
                .filter(option => option.selected)
                .map(option => option.value);
    
            container.innerHTML = 'Cargando informes...';
            currentReports = [];  // Reiniciar el array global
    
            if (selectedClusters.length > 0 && specialty) {
                const cluster_ids = selectedClusters.join(',');
                const url = `/aplicacion1/get_reports_by_clusters_specialty/?cluster_ids=${encodeURIComponent(cluster_ids)}&specialty=${encodeURIComponent(specialty)}`;
    
                fetch(url, { credentials: 'same-origin' })
                    .then(response => response.json())
                    .then(data => {
                        container.innerHTML = ''; // limpiamos el contenedor
    
                        if (data.clusters_reports) {
                            // data.clusters_reports = { "0": [...], "1": [...] }
                            const clustersReports = data.clusters_reports;
                            
                            // Recorremos cada clúster y sus informes
                            for (const [clusterId, reports] of Object.entries(clustersReports)) {
                                // Título de clúster
                                container.innerHTML += `<h4>Clúster ${clusterId}</h4>`;
    
                                if (reports.length > 0) {
                                    reports.forEach((report, indexLocal) => {
                                        // Calculamos un índice global
                                        const globalPos = currentReports.length;
                                        
                                        // Metemos el informe en currentReports
                                        currentReports.push({ clusterId, report });
    
                                        // Añadimos un enlace que referencia globalPos
                                        container.innerHTML += `
                                            <div>
                                                <a href="#" class="report-link" data-globalpos="${globalPos}">
                                                    Informe ${indexLocal + 1}
                                                </a>
                                            </div>
                                        `;
                                    });
                                } else {
                                    container.innerHTML += `<p>No hay informes para este clúster.</p>`;
                                }
                            }
                        } else if (data.message) {
                            container.innerHTML = `<p>${data.message}</p>`;
                        } else {
                            container.innerHTML = 'No se encontraron informes.';
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar los informes:', error);
                        container.innerHTML = 'Error al cargar los informes.';
                    });
            } else {
                container.innerHTML = 'Selecciona al menos un clúster y una especialidad.';
            }
        }
    
        // Función para abrir el modal con un índice global
        function openReportModal(globalIndex) {
            currentIndex = globalIndex;
            reportContent.textContent = currentReports[currentIndex].report;
            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
        }
    
        // Botón "Anterior"
        function showPrevReport() {
            if (currentIndex > 0) {
                currentIndex--;
                reportContent.textContent = currentReports[currentIndex].report;
            }
        }
    
        // Botón "Siguiente"
        function showNextReport() {
            if (currentIndex < currentReports.length - 1) {
                currentIndex++;
                reportContent.textContent = currentReports[currentIndex].report;
            }
        }
    
        // Listeners
        document.getElementById('cluster-select').addEventListener('change', fetchReports);
        document.getElementById('specialty-select').addEventListener('change', fetchReports);
    
        // Cuando el usuario hace clic en un enlace de informe
        container.addEventListener('click', function(event) {
            if (event.target.classList.contains('report-link')) {
                event.preventDefault();
    
                // Tomamos el índice global que guardamos en data-globalpos
                const globalPos = parseInt(event.target.dataset.globalpos, 10);
                openReportModal(globalPos);
            }
        });
    
        prevReportBtn.addEventListener('click', showPrevReport);
        nextReportBtn.addEventListener('click', showNextReport);
    </script>
    
    
    
    
    
    <!-- especialidades -->
    <section class="page-section bg-light" id="VisualizacionEspecialidades">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Visualización de Especialidades</h2>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <iframe src="/aplicacion1/specialties_pie_chart/" style="width: 100%; height: 600px; border: none;"></iframe>
                </div>
            </div>
        </div>
    </section>
<!-- Contacto -->
    <section class="page-section" id="contacto">
        <div class="container">
            <div class="text-center">
                <h2 class="section-heading text-uppercase">Contacto</h2>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-4">
                    <img src="{% static 'assets/img/FotoMia.jpg' %}" class="img-fluid rounded-circle mb-3" alt="Profile Picture">
                </div>
                <div class="col-lg-8">
                    <p class="text-muted">
                        Soy Alejandro Monteliu López, alumno de cuarto curso de Ingeniería Informática en la Universidad Francisco de Vitoria. Actualmente, estoy trabajando como becario en la empresa Management Solutions, con la intención de incorporarme de manera completa el año que viene. Durante mi formación académica, he adquirido conocimientos sólidos en diversas áreas de la informática, incluyendo programación, bases de datos, inteligencia artificial y desarrollo de software.
                        
                        En mi experiencia como becario en Management Solutions, he tenido la oportunidad de aplicar estos conocimientos en proyectos reales, colaborando en el desarrollo de soluciones tecnológicas para mejorar la eficiencia y efectividad de los procesos empresariales. He trabajado en equipos multidisciplinarios, lo que me ha permitido desarrollar habilidades en la gestión de proyectos, resolución de problemas y comunicación efectiva.
                        
                        Además, me apasiona la tecnología y estoy siempre en busca de nuevas oportunidades para aprender y crecer profesionalmente. Participé en varios proyectos extracurriculares y hackathons, lo que me ha permitido ampliar mis competencias y mantenerme al día con las últimas tendencias y avances en el campo de la informática.
                        
                        Mi objetivo es seguir desarrollándome como profesional en el ámbito de la ingeniería informática, contribuyendo con mis habilidades y conocimientos a proyectos innovadores que generen un impacto positivo. Estoy comprometido con la excelencia y la mejora continua, y estoy entusiasmado por las oportunidades que el futuro me depara en este campo apasionante.
                    </p>
                    <div class="mt-3">
                        <a href="https://www.linkedin.com/in/alejandro-monteliu-l%C3%B3pez-a74a11287//" class="btn btn-outline-primary btn-social mx-1">
                            <i class="fab fa-linkedin-in"></i>
                        </a>
                        <a href="https://github.com/AlexMonteliu" class="btn btn-outline-dark btn-social mx-1">
                            <img src="{% static 'assets/img/gtihub2.svg' %}" alt="GitHub Logo" style="width: 24px; height: 24px;">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer -->
    <footer class="footer py-4">
        <div class="container">
        </div>
    </footer>
    <!-- Bootstrap core JS -->
     <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS -->
    <script src="{% static 'js/scripts.js' %}"></script>
    <!-- SB Forms JS -->
    <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome for icons (optional) -->
<!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"> -->
<!-- jQuery and Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!-- Bootstrap CSS -->
<!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"> -->
<!-- Font Awesome for icons (optional) -->
<!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"> -->
<!-- jQuery and Bootstrap JS -->
<!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script> -->
<!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> -->
  
</body>
</html>
